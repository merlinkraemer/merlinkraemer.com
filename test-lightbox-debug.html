<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lightbox Debug Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: white;
      }
      .success {
        color: green;
        font-weight: bold;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      .info {
        color: blue;
      }
      .warning {
        color: orange;
        font-weight: bold;
      }
      button {
        margin: 5px;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .test-results {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
      }
      .console-output {
        background: #000;
        color: #0f0;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin: 10px 0;
      }
      .step {
        margin: 10px 0;
        padding: 10px;
        background: #e7f3ff;
        border-radius: 3px;
        border-left: 4px solid #007bff;
      }
    </style>
  </head>
  <body>
    <h1>üîç Lightbox Debug Test</h1>
    <p>
      <strong
        >This test will help us debug why the lightbox is still
        re-rendering.</strong
      >
    </p>

    <div class="test-section">
      <h3>üìã Test Steps</h3>
      <div class="step">
        <strong>Step 1:</strong> Open
        <a href="http://localhost:5174" target="_blank"
          >http://localhost:5174</a
        >
      </div>
      <div class="step">
        <strong>Step 2:</strong> Open DevTools Console (F12)
      </div>
      <div class="step">
        <strong>Step 3:</strong> Click "Start Monitoring" button below
      </div>
      <div class="step">
        <strong>Step 4:</strong> Click any image to open lightbox
      </div>
      <div class="step">
        <strong>Step 5:</strong> Close lightbox (ESC or click outside)
      </div>
      <div class="step"><strong>Step 6:</strong> Reopen same image</div>
      <div class="step">
        <strong>Step 7:</strong> Check the console output below
      </div>
    </div>

    <div class="test-section">
      <h3>üéõÔ∏è Debug Controls</h3>
      <button onclick="startMonitoring()">Start Monitoring</button>
      <button onclick="stopMonitoring()">Stop Monitoring</button>
      <button onclick="clearConsole()">Clear Console</button>
      <button onclick="checkReactComponents()">Check React Components</button>
      <button onclick="testComponentLifecycle()">
        Test Component Lifecycle
      </button>
    </div>

    <div class="test-section">
      <h3>üìä Console Output</h3>
      <div id="console-output" class="console-output">
        Click "Start Monitoring" to begin...
      </div>
    </div>

    <div class="test-section">
      <h3>üîç Analysis Results</h3>
      <div id="analysis-results" class="test-results">
        <div class="info">Waiting for test data...</div>
      </div>
    </div>

    <div class="test-section">
      <h3>üìà Performance Metrics</h3>
      <div id="performance-metrics" class="test-results">
        <div class="info">No data yet...</div>
      </div>
    </div>

    <script>
      let monitoring = false;
      let originalConsole = {};
      let componentMounts = 0;
      let componentUnmounts = 0;
      let renderCount = 0;
      let startTime = 0;

      function startMonitoring() {
        monitoring = true;
        componentMounts = 0;
        componentUnmounts = 0;
        renderCount = 0;
        startTime = performance.now();

        // Override console methods to capture logs
        originalConsole.log = console.log;
        originalConsole.warn = console.warn;
        originalConsole.error = console.error;

        console.log = function (...args) {
          logToConsole("LOG", args.join(" "));
          originalConsole.log.apply(console, args);
        };

        console.warn = function (...args) {
          logToConsole("WARN", args.join(" "));
          originalConsole.warn.apply(console, args);
        };

        console.error = function (...args) {
          logToConsole("ERROR", args.join(" "));
          originalConsole.error.apply(console, args);
        };

        // Monitor React component lifecycle
        if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
          const hook = window.__REACT_DEVTOOLS_GLOBAL_HOOK__;
          const originalOnCommitFiberRoot = hook.onCommitFiberRoot;

          hook.onCommitFiberRoot = function (id, root, priorityLevel) {
            renderCount++;
            logToConsole("RENDER", `React render #${renderCount}`);

            if (originalOnCommitFiberRoot) {
              originalOnCommitFiberRoot.call(this, id, root, priorityLevel);
            }
          };
        }

        // Monitor DOM changes
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.type === "childList") {
              mutation.addedNodes.forEach(function (node) {
                if (
                  node.nodeType === 1 &&
                  node.classList &&
                  node.classList.contains("lightbox-container")
                ) {
                  componentMounts++;
                  logToConsole("MOUNT", "Lightbox component mounted");
                }
              });
              mutation.removedNodes.forEach(function (node) {
                if (
                  node.nodeType === 1 &&
                  node.classList &&
                  node.classList.contains("lightbox-container")
                ) {
                  componentUnmounts++;
                  logToConsole("UNMOUNT", "Lightbox component unmounted");
                }
              });
            }
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });

        logToConsole("INFO", "Monitoring started - now test the lightbox!");
        updateAnalysis();
      }

      function stopMonitoring() {
        monitoring = false;

        // Restore original console methods
        console.log = originalConsole.log;
        console.warn = originalConsole.warn;
        console.error = originalConsole.error;

        logToConsole("INFO", "Monitoring stopped");
        updateAnalysis();
      }

      function clearConsole() {
        document.getElementById("console-output").innerHTML =
          "Console cleared...";
      }

      function logToConsole(level, message) {
        const consoleOutput = document.getElementById("console-output");
        const timestamp = new Date().toLocaleTimeString();
        const levelClass = level.toLowerCase();
        const logEntry = `<div class="${levelClass}">[${timestamp}] ${level}: ${message}</div>`;
        consoleOutput.innerHTML += logEntry;
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
      }

      function checkReactComponents() {
        const results = document.getElementById("analysis-results");

        if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
          results.innerHTML = `
            <div class="success">‚úÖ React DevTools detected</div>
            <div class="info">Component mounts: ${componentMounts}</div>
            <div class="info">Component unmounts: ${componentUnmounts}</div>
            <div class="info">Render count: ${renderCount}</div>
            <div class="info">If mounts > unmounts, component is staying mounted ‚úÖ</div>
            <div class="info">If mounts = unmounts, component is re-mounting ‚ùå</div>
          `;
        } else {
          results.innerHTML = `
            <div class="error">‚ùå React DevTools not detected</div>
            <div class="info">Install React DevTools extension for better debugging</div>
          `;
        }
      }

      function testComponentLifecycle() {
        const results = document.getElementById("analysis-results");

        // Simulate component lifecycle test
        logToConsole("TEST", "Testing component lifecycle...");

        // Check if we can detect React components
        if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
          const hook = window.__REACT_DEVTOOLS_GLOBAL_HOOK__;
          const fiberRoots = hook.getFiberRoots(1);

          let lightboxFound = false;
          fiberRoots.forEach((root) => {
            if (root.current && root.current.child) {
              // Look for Lightbox component in the tree
              const findLightbox = (fiber) => {
                if (fiber.type && fiber.type.name === "Lightbox") {
                  lightboxFound = true;
                  logToConsole(
                    "FOUND",
                    "Lightbox component found in React tree"
                  );
                }
                if (fiber.child) findLightbox(fiber.child);
                if (fiber.sibling) findLightbox(fiber.sibling);
              };
              findLightbox(root.current);
            }
          });

          if (lightboxFound) {
            results.innerHTML = `
              <div class="success">‚úÖ Lightbox component found in React tree</div>
              <div class="info">This means it's mounted and should persist</div>
            `;
          } else {
            results.innerHTML = `
              <div class="warning">‚ö†Ô∏è Lightbox component not found in React tree</div>
              <div class="info">This might mean it's not mounted or has a different name</div>
            `;
          }
        } else {
          results.innerHTML = `
            <div class="error">‚ùå React DevTools not available</div>
            <div class="info">Cannot inspect React component tree</div>
          `;
        }
      }

      function updateAnalysis() {
        const results = document.getElementById("analysis-results");
        const duration = monitoring
          ? (performance.now() - startTime) / 1000
          : 0;

        results.innerHTML = `
          <div class="info"><strong>Test Duration:</strong> ${duration.toFixed(
            1
          )}s</div>
          <div class="info"><strong>Component Mounts:</strong> ${componentMounts}</div>
          <div class="info"><strong>Component Unmounts:</strong> ${componentUnmounts}</div>
          <div class="info"><strong>Render Count:</strong> ${renderCount}</div>
          <div class="info"><strong>Status:</strong> ${
            monitoring ? "Monitoring..." : "Stopped"
          }</div>
          <br>
          <div class="info"><strong>Analysis:</strong></div>
          ${
            componentMounts === componentUnmounts
              ? '<div class="error">‚ùå Component is re-mounting (BAD)</div>'
              : '<div class="success">‚úÖ Component is staying mounted (GOOD)</div>'
          }
          ${
            renderCount > 10
              ? '<div class="warning">‚ö†Ô∏è High render count - possible performance issue</div>'
              : '<div class="success">‚úÖ Render count looks normal</div>'
          }
        `;
      }

      // Update analysis every second when monitoring
      setInterval(() => {
        if (monitoring) {
          updateAnalysis();
        }
      }, 1000);

      // Initial setup
      logToConsole("INFO", "Debug test page loaded");
      logToConsole("INFO", 'Click "Start Monitoring" then test the lightbox');
    </script>
  </body>
</html>
